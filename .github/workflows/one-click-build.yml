name: ðŸš€ EZ-Theme ä¸€é”®æ‰“åŒ…

on:
  workflow_dispatch:
    inputs:
      title:
        description: 'ç½‘ç«™æ ‡é¢˜'
        required: true
        default: 'EZ-DEMO-TITLE'
        type: string
      env:
        description: 'çŽ¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - development
      debugging:
        description: 'å¯ç”¨åè°ƒè¯•'
        required: true
        default: true
        type: boolean
      obfuscation:
        description: 'é…ç½®æ··æ·†'
        required: true
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    # å¦‚æžœä½ çš„å‰ç«¯ä½äºŽå­ç›®å½•ï¼ˆä¾‹å¦‚ frontend/ æˆ– nothing-front/ï¼‰ï¼Œå°† FRONTEND_DIR æ”¹ä¸ºç›¸å¯¹è·¯å¾„ï¼ˆå¦‚: ./nothing-frontï¼‰
    env:
      FRONTEND_DIR: .  # é»˜è®¤æ ¹ç›®å½•ã€‚å¦‚éœ€è®¾ç½®å­ç›®å½•æ”¹æˆ ./your-frontend-dir

    steps:
    - name: ðŸ“¥ èŽ·å–ä»£ç 
      uses: actions/checkout@v3

    - name: ðŸ§­ æ˜¾ç¤ºå·¥ä½œç›®å½•ï¼ˆè°ƒè¯•ç”¨ï¼‰ 
      # åˆ—å‡ºæ–‡ä»¶ï¼Œå¸®åŠ©ç¡®è®¤æˆ‘ä»¬æ˜¯å¦åœ¨æ­£ç¡®ç›®å½•ï¼ˆè‹¥ä½ çš„å‰ç«¯åœ¨å­ç›®å½•è¯·ä¿®æ”¹ FRONTEND_DIRï¼‰
      run: |
        echo "å·¥ä½œåŒº: $GITHUB_WORKSPACE"
        echo "åˆ‡æ¢åˆ°å‰ç«¯ç›®å½•: ${{ env.FRONTEND_DIR }}"
        ls -la
        ls -la ${{ env.FRONTEND_DIR }} || true

    - name: ðŸ”§ è®¾ç½® Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ“¦ å®‰è£…ä¾èµ–å¹¶ç¡®ä¿ç”Ÿæˆ package-lock.json
      working-directory: ${{ env.FRONTEND_DIR }}    # è‹¥å‰ç«¯åœ¨å­ç›®å½•ï¼Œç¡®ä¿è¿™é‡ŒæŒ‡å‘æ­£ç¡®ç›®å½•
      run: |
        # å®‰è£…ä¾èµ–ï¼ˆæ­£å¸¸æµç¨‹ï¼‰
        npm install

        # å®‰å…¨ç”Ÿæˆ package-lock.jsonï¼ˆåªç”Ÿæˆé”æ–‡ä»¶ï¼Œä¸é‡æ–°å®‰è£…ï¼‰
        # è‹¥å‘½ä»¤å¤±è´¥ï¼ˆä¾‹å¦‚é¡¹ç›®ä½¿ç”¨ pnpm/yarnï¼‰ï¼Œåˆ™é™çº§åˆ›å»ºä¸€ä¸ªæœ€å°çš„ package-lock.json æ–‡ä»¶ä»¥æ»¡è¶³éœ€è¦æ£€æµ‹å­˜åœ¨æ€§çš„ action
        npm i --package-lock-only --no-audit --no-fund || echo '{}' > package-lock.json

        # æ˜¾ç¤ºæ˜¯å¦ç”ŸæˆæˆåŠŸï¼ˆè°ƒè¯•ï¼‰
        echo "package-lock.json æ˜¯å¦å­˜åœ¨:"
        ls -la package-lock.json || true
        echo "package.json:"
        ls -la package.json || true

    - name: âš™ï¸ åˆ›å»ºçŽ¯å¢ƒé…ç½® (.env.production)
      working-directory: ${{ env.FRONTEND_DIR }}
      run: |
        # ç”Ÿæˆç”Ÿäº§çŽ¯å¢ƒ .env æ–‡ä»¶ï¼Œæ³¨æ„è¿™é‡Œæ²¡æœ‰é¢å¤–ç©ºæ ¼ï¼ˆé¿å…è§£æžé—®é¢˜ï¼‰
        cat > .env.production << EOF
NODE_ENV=production
VUE_APP_TITLE=${{ github.event.inputs.title }}
VUE_APP_ENV=${{ github.event.inputs.env }}
VUE_APP_DEBUGGING=${{ github.event.inputs.debugging }}
VUE_APP_CONFIGJS=true
VUE_APP_OBFUSCATION=${{ github.event.inputs.obfuscation }}
EOF

    - name: ðŸ”¨ æ‰§è¡Œæž„å»º
      working-directory: ${{ env.FRONTEND_DIR }}
      run: |
        npm run build

    - name: ðŸ“¦ æ‰“åŒ…æž„å»ºæ–‡ä»¶
      working-directory: ${{ env.FRONTEND_DIR }}
      run: |
        # å°† dist æ‰“åŒ…åˆ°ä»“åº“æ ¹ç›®å½•çš„ build.zipï¼Œç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®
        zip -r $GITHUB_WORKSPACE/build.zip dist/
        # æ˜¾ç¤ºæ‰“åŒ…ç»“æžœï¼ˆè°ƒè¯•ï¼‰
        ls -la $GITHUB_WORKSPACE/build.zip

    - name: ðŸš€ åˆ›å»º Releaseï¼ˆå®˜æ–¹ actionï¼‰
      id: release
      uses: actions/create-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        release_name: "ðŸš€ EZ-Theme æž„å»º ${{ github.run_number }}"
        body: |
          ## ðŸŽ‰ æž„å»ºå®Œæˆï¼

          ### ðŸ“‹ æž„å»ºé…ç½®
          - **ç½‘ç«™æ ‡é¢˜**: ${{ github.event.inputs.title }}
          - **çŽ¯å¢ƒ**: ${{ github.event.inputs.env }}
          - **åè°ƒè¯•**: ${{ github.event.inputs.debugging }}
          - **é…ç½®æ··æ·†**: ${{ github.event.inputs.obfuscation }}
          - **ç‹¬ç«‹é…ç½®**: âœ… å¼ºåˆ¶å¯ç”¨

          ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
          1. ç‚¹å‡»ä¸‹æ–¹çš„ `build.zip` ä¸‹è½½æž„å»ºæ–‡ä»¶
          2. è§£åŽ‹åŽä¸Šä¼ åˆ°æ‚¨çš„æœåŠ¡å™¨
          3. é…ç½® Web æœåŠ¡å™¨æŒ‡å‘ `dist` ç›®å½•

          ### ðŸ“± æŠ€æœ¯æ”¯æŒ
          [@hami9ua](https://t.me/hami9ua)
        draft: false
        prerelease: false
      # create-release ä¼šè‡ªåŠ¨ä½¿ç”¨ GITHUB_TOKENï¼ˆæ— éœ€æ˜¾å¼æä¾›ï¼‰

    - name: ðŸ“¦ ä¸Šä¼ æž„å»ºæ–‡ä»¶åˆ° Releaseï¼ˆå®˜æ–¹ actionï¼‰
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.release.outputs.upload_url }}
        asset_path: ${{ github.workspace }}/build.zip
        asset_name: build.zip
        asset_content_type: application/zip
